<div th:fragment="content">
    <div class="d-flex align-items-center mb-3">
        <h2 class="me-3 mb-0">Upload Image of your analog habit tracker</h2>
    </div>

    <div th:if="${uploadSuccess}" class="alert alert-success" role="alert">
        <span th:text="${uploadSuccess}"></span>
    </div>
    <div th:if="${uploadError}" class="alert alert-danger" role="alert">
        <span th:text="${uploadError}"></span>
    </div>
    <div th:if="${importSuccess}" class="alert alert-success" role="alert">
        <span th:text="${importSuccess}"></span>
    </div>
    <div th:if="${importError}" class="alert alert-danger" role="alert">
        <span th:text="${importError}"></span>
    </div>
    <div th:if="${analysisError}" class="alert alert-warning" role="alert">
        <span th:text="${analysisError}"></span>
    </div>

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Upload image</h5>
                    <form th:action="@{/uploads}" method="post" enctype="multipart/form-data" class="mb-3">
                        <div class="mb-3">
                            <label for="file" class="form-label">Choose Image</label>
                            <p class="text-muted small">Maximum filesize is 20MB</p>
                            <input class="form-control" type="file" id="file" name="file" accept="image/*" required />
                        </div>
                        <button type="submit" class="btn btn-primary">Upload Image</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Analyze uploaded image</h5>
                    <p class="text-muted small">Select an uploaded picture, choose the month/year and start the Python-based detection.</p>
                    <form th:action="@{/uploads/analyze}" method="post" class="d-grid gap-3">
                        <div>
                            <label for="imageId" class="form-label">Uploaded image</label>
                            <select class="form-select" id="imageId" name="imageId" required>
                                <option value="" selected disabled>Choose an image</option>
                                <option th:each="upload : ${uploadedImages}" th:value="${upload.id}" th:text="${upload.originalFilename}"></option>
                            </select>
                        </div>
                        <div>
                            <label for="yearMonth" class="form-label">Month</label>
                            <input type="month" class="form-control" id="yearMonth" name="yearMonth" th:value="${selectedYearMonth}" required />
                        </div>
                        <button type="submit" class="btn btn-outline-primary" th:disabled="${#lists.isEmpty(uploadedImages)}">Analyze &amp; build table</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h4>Uploaded Images</h4>
        <p class="text-muted" th:if="${#lists.isEmpty(uploadedImages)}">No uploads so far.</p>
        <ul class="list-group" th:if="${!#lists.isEmpty(uploadedImages)}">
            <li class="list-group-item d-flex justify-content-between align-items-center" th:each="upload : ${uploadedImages}">
                <div>
                    <div class="fw-semibold" th:text="${upload.originalFilename}"></div>
                    <div class="small text-muted">Saved at <span th:text="${#temporals.format(upload.uploadedAt, 'dd.MM.yyyy HH:mm')}"></span></div>
                    <div class="small">Path: <span th:text="${upload.storagePath}"></span></div>
                </div>
                <a class="btn btn-outline-secondary btn-sm" th:href="@{'/uploaded-images/' + ${upload.storedFilename}}" target="_blank">Open</a>
            </li>
        </ul>
    </div>

    <div class="mt-4" th:if="${importForm != null}">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h4 class="mb-0">Review detected table</h4>
                <p class="text-muted mb-0">Habits are listed in the predefined order (priority, then creation order). Adjust checkmarks before saving.</p>
            </div>
            <div class="text-end">
                <div class="fw-semibold" th:text="${importForm.uploadedImageName}"></div>
                <div class="small text-muted" th:if="${!#lists.isEmpty(monthDays)}" th:text="${#temporals.format(monthDays.get(0), 'MMMM yyyy')}"></div>
            </div>
        </div>

        <form th:action="@{/uploads/import}" th:object="${importForm}" method="post">
            <input type="hidden" th:field="*{uploadedImageId}" />
            <input type="hidden" th:field="*{uploadedImageName}" />
            <input type="hidden" th:field="*{year}" />
            <input type="hidden" th:field="*{month}" />

            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center">
                    <thead class="table-light">
                        <tr>
                            <th class="text-start">Habit</th>
                            <th th:each="day : ${monthDays}" th:text="${#temporals.format(day, 'dd.MM.')}" scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="row, rowStat : *{rows}">
                            <td class="text-start">
                                <span th:text="${row.habitName}"></span>
                                <input type="hidden" th:field="*{rows[__${rowStat.index}__].habitId}" />
                                <input type="hidden" th:field="*{rows[__${rowStat.index}__].habitName}" />
                            </td>
                            <td th:each="day, dayStat : ${monthDays}">
                                <div class="form-check d-flex justify-content-center">
                                    <input class="form-check-input" type="checkbox" th:field="*{rows[__${rowStat.index}__].days[__${dayStat.index}__]}" />
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-end mt-3">
                <button type="submit" class="btn btn-primary">Save detections</button>
            </div>
        </form>
    </div>
</div>
