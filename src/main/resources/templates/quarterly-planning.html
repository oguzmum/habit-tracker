<div th:fragment="content" class="planning-scope">
    <style>
        .planning-scope {
          --bg: #ffffff;
          --text: #111111;
          --muted: #6a6d75;
          --grid: #111111;         /* Tabellenlinien */
          --panel: #ffffff;        /* Karten-Hintergrund */
          --panel-border: #e5e7eb; /* Karten-Rand hell */
          --input-bg: #ffffff;     /* Input-Felder */
          --input-border: #d1d5db; /* Input-Rand */
          --dash-border: #e5e7eb;  /* gestrichelte UA-Boxen */
          --hover: #f3f4f6;        /* Button-Hover */
        }
        /* Box-Sizing + Overflow-Grundlage */
        .planning-scope, .planning-scope * , .planning-scope *::before, .planning-scope *::after {
          box-sizing: border-box;
        }

        /* --- Layout & Typo --- */
        .planning-scope .wrap {
          max-width: 1200px;
          margin: auto;
          padding: 24px;
          background: var(--bg);
          color: var(--text);
          font-family: system-ui, Segoe UI, Roboto, Inter, Arial, sans-serif;
        }
        .planning-scope h1 { margin: 0 0 14px 0; font-size: 22px; }
        .planning-scope .hint { color: var(--muted); margin-bottom: 14px; font-size: 14px; }

        /* --- Tabelle --- */
        .planning-scope table.planning {
          width: 100%;
          border-collapse: collapse;
          table-layout: fixed;
          border: 2px solid var(--grid);
          background: var(--bg);
        }
        .planning-scope .planning td {
          border: 1.5px solid var(--grid);
          vertical-align: top;
          padding: 10px;
          background: var(--bg);
          overflow: visible;       /* Buttons nicht abschneiden */
        }
        .planning-scope .planning td > * { max-width: 100%; }

        /* Label-Spalte */
        .planning-scope .label-cell{
          width: 180px;
          font-family: ui-serif, Georgia, serif;
          font-size: 22px;
          color: var(--text);
          background: #fafafa;
          letter-spacing: .5px;
          border-right: 1.5px solid var(--grid);
        }

        /* --- Year row merged --- */
        .planning-scope .year-row .year-cell { padding: 10px; }
        .planning-scope .year-grid {
          display: grid;
          grid-template-columns: repeat(4, minmax(0, 1fr)); /* minmax(0,1fr) verhindert Ãœberlauf */
          gap: 12px;
        }

        /* --- Karten/Zellen --- */
        .planning-scope .cell,
        .planning-scope .card{
          background: var(--panel);
          border: 1px solid var(--panel-border);
          border-radius: 12px;
          padding: 10px;
          display: flex;
          flex-direction: column;
          gap: 8px;
          width: 100%;
          max-width: 100%;
          min-width: 0; /* darf schrumpfen */
        }

        .planning-scope .cell-header,
        .planning-scope .card-header{
          display: flex;
          gap: 8px;
          align-items: center;
          min-width: 0; /* verhindert Ãœberlauf durch breiten Input */
        }

        .planning-scope .cell-title,
        .planning-scope .card-title{
          flex: 1 1 auto;
          min-width: 0;                 /* wichtig fÃ¼r Flex-Schrumpfen */
          background: var(--input-bg);
          border: 1px solid var(--input-border);
          color: var(--text);
          padding: 8px 10px;
          border-radius: 10px;
          font-weight: 600;
          position: relative;
          z-index: 1;
        }

        /* --- Buttons --- */
        .planning-scope .btn{
          background: #fff;
          color: var(--text);
          border: 1px solid var(--grid);
          border-radius: 8px;
          padding: 6px 10px;
          cursor: pointer;
          font-size: 13px;
          position: relative;
          z-index: 2; /* Ã¼ber Inputs */
        }
        .planning-scope .btn.small{ padding: 4px 8px; font-size: 12px; }
        .planning-scope .btn.danger{ border-color: #ef4444; }
        .planning-scope .btn:hover{ background: var(--hover); }

        /* --- Unteraufgaben --- */
        .planning-scope .items{ display: flex; flex-direction: column; gap: 6px; }
        .planning-scope .item{
          display: grid;
          grid-template-columns: auto 1fr auto;
          gap: 8px;
          align-items: center;
          padding: 6px 8px;
          border: 1px dashed var(--dash-border);
          border-radius: 8px;
          background: #fff;
        }
        .planning-scope .item input[type="text"]{
          width: 100%;
          min-width: 0;   /* darf schrumpfen */
          background: transparent;
          border: none;
          color: var(--text);
          outline: none;
          font-size: 14px;
          padding: 4px 2px;
        }

        /* --- Responsiv --- */
        @media (max-width: 1000px){
          .planning-scope .year-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        @media (max-width: 620px){
          .planning-scope .year-grid { grid-template-columns: minmax(0, 1fr); }
          .planning-scope .label-cell{ width: 120px; font-size: 18px; }
        }
    </style>


    <div class="wrap">
        <h1>Ziele - Quartelsplanung</h1>

        <table class="planning" id="planTable">
            <tbody>
            <tr class="year-row">
                <td class="label-cell">Jahr</td>
                <td class="year-cell" colspan="4">
                    <div class="year-toolbar" style="margin-bottom:8px;">
                        <button class="btn small" data-action="add-card">+ Top-Ziel</button>
                    </div>
                    <div class="year-grid" id="yearGrid"></div>
                </td>
            </tr>



            <tr class="top-year-goals-row">
                <td class="label-cell">Top-Jahresziele [[${selectedYear}]]</td>
                <td class="year-cell" colspan="4">
                    <div th:if="${#lists.isEmpty(topYearGoals)}" class="muted">
                        Keine Top-Jahresziele fÃ¼r [[${selectedYear}]] hinterlegt.
                    </div>

                    <div th:each="g : ${topYearGoals}" class="goal-card" style="margin-bottom:12px; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <div style="display:flex; align-items:center; gap:8px; justify-content:space-between;">
                            <h3 style="margin:0;" th:text="${g.name}">Zielname</h3>
                            <!-- optional: Link zur Detailseite -->
                            <a th:href="@{/goals/{id}(id=${g.id})}" class="btn small">Details</a>
                        </div>
                        <p th:if="${g.description}" class="muted" th:text="${g.description}">Beschreibungâ€¦</p>

                        <!-- Subgoals-Liste -->
                        <div th:with="subs=${subGoalsByGoal[g.id]}">
                            <ul th:if="${subs != null and !#lists.isEmpty(subs)}" style="margin:8px 0 0 16px;">
                                <li th:each="sg : ${subs}">
                                    <span th:text="${sg.name}">Subgoal</span>
                                    <!-- Optional: Labels zu Quarter/Month -->
                                    <span class="muted" th:if="${sg.quarter != null}">
              â€” [[${quarterLabels[sg.quarter.name()]}]]
            </span>
                                    <span class="muted" th:if="${sg.month != null}">
              â€” [[${monthLabels[sg.month.name()]}]]
            </span>
                                    <!-- Optional: Edit/Delete Actions -->
                                    <!--
                                    <form th:action="@{/subgoals/delete/{id}(id=${sg.id})}" method="post" style="display:inline;">
                                      <input type="hidden" name="year" th:value="${selectedYear}"/>
                                      <button class="link danger" type="submit">LÃ¶schen</button>
                                    </form>
                                    -->
                                </li>
                            </ul>

                            <p class="muted" th:if="${subs == null or #lists.isEmpty(subs)}">
                                Dieses Ziel hat keine Subgoals.
                            </p>
                        </div>

                        <!-- Optional: Formular zum schnellen Anlegen eines Subgoals fÃ¼r dieses Ziel -->
                        <!--
                        <form th:action="@{/subgoals/create}" method="post" style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                          <input type="text" name="name" placeholder="Neues Subgoalâ€¦" required class="input">
                          <input type="hidden" name="goalId" th:value="${g.id}">
                          <input type="hidden" name="year" th:value="${selectedYear}">
                          <select name="quarter">
                            <option th:each="q : ${quarters}" th:value="${q}" th:text="${quarterLabels[q.name()]}">Quartal</option>
                          </select>
                          <select name="month">
                            <option value="">(Monat optional)</option>
                            <option th:each="m : ${monthLabels.entrySet()}" th:value="${m.key}" th:text="${m.value}">Monat</option>
                          </select>
                          <button class="btn small" type="submit">+ Subgoal</button>
                        </form>
                        -->
                    </div>
                </td>
            </tr>


            <tr>
                <td class="label-cell">Quartal</td>

                <!-- Vier Spalten: Q1..Q4 -->
                <td th:each="q : ${quarters}">
                    <div class="cell">
                        <div class="cell-header">
                            <div class="cell-title" th:text="${quarterLabels[q.name()]}">Quartal X</div>
                            <!-- Optional: Quick-Add-Form fÃ¼r Subgoal in genau DIESEM Quartal -->
                            <!--
                            <form th:action="@{/subgoals/create}" method="post" style="display:flex; gap:8px; align-items:center;">
                              <input type="text" name="name" placeholder="Neues Subgoal â€¦" required>
                              <input type="hidden" name="year" th:value="${selectedYear}">
                              <input type="hidden" name="quarter" th:value="${q}">
                              <select name="goalId" required>
                                <option value="" disabled selected>Goal wÃ¤hlenâ€¦</option>
                                <option th:each="g : ${allGoals}" th:value="${g.id}" th:text="${g.name}">Goal</option>
                              </select>
                              <button class="btn small" type="submit">+ UA</button>
                            </form>
                            -->
                        </div>

                        <!-- Inhalt: Liste der Subgoals fÃ¼r das Quartal -->
                        <div th:with="subs=${quarterSubGoals[q]}">
                            <ul class="items" th:if="${subs != null and !#lists.isEmpty(subs)}" style="margin-top:6px;">
                                <li class="item" th:each="sg : ${subs}">
                                    <input type="checkbox" th:checked="${sg.done}" disabled>
                                    <span>
                                      <strong th:text="${sg.name}">Subgoal</strong>
                                      <span class="muted" th:if="${sg.goal != null}"> â€” [[${sg.goal.name}]]</span>
                                      <span class="muted" th:if="${sg.month != null}"> â€” [[${monthLabels[sg.month.name()]}]]</span>
                                    </span>
                                    <!-- Optional: Aktionen -->
                                    <!--
                                    <form th:action="@{/subgoals/delete/{id}(id=${sg.id})}" method="post">
                                      <input type="hidden" name="year" th:value="${selectedYear}">
                                      <button class="btn small danger" type="submit">âœ•</button>
                                    </form>
                                    -->
                                </li>
                            </ul>

                            <p class="muted" th:if="${subs == null or #lists.isEmpty(subs)}" style="margin:6px 0 0;">
                                Keine Subgoals fÃ¼r dieses Quartal.
                            </p>
                        </div>
                    </div>
                </td>
            </tr>

            <tr>
                <td class="label-cell">Monat</td>
                <td data-section="month1" data-col="1"></td>
                <td data-section="month1" data-col="2"></td>
                <td data-section="month1" data-col="3"></td>
                <td data-section="month1" data-col="4"></td>
            </tr>
            <tr>
                <td class="label-cell">Monat</td>
                <td data-section="month2" data-col="1"></td>
                <td data-section="month2" data-col="2"></td>
                <td data-section="month2" data-col="3"></td>
                <td data-section="month2" data-col="4"></td>
            </tr>
            <tr>
                <td class="label-cell">Monat</td>
                <td data-section="month3" data-col="1"></td>
                <td data-section="month3" data-col="2"></td>
                <td data-section="month3" data-col="3"></td>
                <td data-section="month3" data-col="4"></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Templates -->
    <template id="cell-template">
        <div class="cell">
            <div class="cell-header">
                <input class="cell-title" placeholder="Titel des Ziels â€¦" />
                <button class="btn small" data-action="add-item">+ UA</button>
                <button class="btn small danger" data-action="clear-cell" title="Alle Unteraufgaben leeren">ðŸ—‘</button>
            </div>
            <div class="items"></div>
        </div>
    </template>

    <template id="card-template">
        <div class="card">
            <div class="card-header">
                <input class="card-title" placeholder="Top-Jahresziel â€¦" />
                <button class="btn small" data-action="add-item">+ UA</button>
                <button class="btn small danger" data-action="remove-card" title="Karte lÃ¶schen">ðŸ—‘</button>
            </div>
            <div class="items"></div>
        </div>
    </template>

    <template id="item-template">
        <div class="item">
            <input type="checkbox" />
            <input type="text" placeholder="Subgoal / -task" />
            <button class="btn small danger" data-action="remove-item">âœ•</button>
        </div>
    </template>

    <script>
        const $ = (s, r=document)=>r.querySelector(s);
        const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
        const tpl = id => document.getElementById(id).content.firstElementChild.cloneNode(true);

        function makeItems(container, n=3){ for(let i=0;i<n;i++) container.appendChild(tpl('item-template')); }

        function populateCell(td, title, items=3){
          const node = tpl('cell-template');
          node.querySelector('.cell-title').value = title;
          makeItems(node.querySelector('.items'), items);
          td.appendChild(node);
        }

        function addYearCard(title="Top-Jahresziel", items=3){
          const grid = $('#yearGrid');
          const card = tpl('card-template');
          card.querySelector('.card-title').value = title;
          makeItems(card.querySelector('.items'), items);
          grid.appendChild(card);
        }

        function init(){
          ["Top Jahresziel 1","Top Jahresziel 2","Top Jahresziel 3","Top Jahresziel 4"].forEach(t => addYearCard(t, 3));

          ["Quartalsziel 1","Quartalsziel 2","Quartalsziel 3","Quartalsziel 4"]
            .forEach((t,i)=> populateCell($$('#planTable td[data-section="quarter"]')[i], t, 3));

          ["month1","month2","month3"].forEach((sec, r)=>{
            $$('#planTable td[data-section="'+sec+'"]').forEach((td, c)=>{
              populateCell(td, `Monatsziel ${r+1}.${c+1}`, 3);
            });
          });
        }

        document.addEventListener('click', (e)=>{
          const btn = e.target.closest('button'); if(!btn) return;
          const act = btn.dataset.action;

          if(act === 'add-item'){
            const holder = btn.closest('.cell, .card').querySelector('.items');
            holder.appendChild(tpl('item-template'));
          }
          if(act === 'remove-item'){ btn.closest('.item').remove(); }
          if(act === 'clear-cell'){ btn.closest('.cell').querySelector('.items').innerHTML=''; }
          if(act === 'remove-card'){ btn.closest('.card').remove(); }
          if(act === 'add-card'){ addYearCard(`Top Jahresziel ${$('#yearGrid').children.length+1}`, 3); }
        });

        init();
    </script>
</div>
